general:
  build_dir: terminology_server
  artifacts:
    - "coverage/"

dependencies:
  pre:
    - sudo apt-get update
    - sudo apt-get install python3-all-dev
    - pyenv global 3.5.1 2.7.11
    - sudo apt-get install postgresql-plpython-9.5 postgresql-9.5-plv8
    - cp ../.pypirc $HOME/.pypirc
    - if [[ ! -e $HOME/.pip ]]; then mkdir $HOME/.pip; fi
    - cp ../.pip.conf $HOME/.pip/pip.conf
    - pip install -r requirements-test.txt
    - ../auth-gcloud.sh
    - sudo bash ../sync-test-data.sh
  cache_directories:
    - ~/.ssh
    - /opt/snomedct_terminology_server/final_build_data/

test:
  override:
    - run ci_db_user
    - run test:
        timeout: 3600
        environment:
            DATABASE_URL: postgres://ubuntu@localhost:5432/circle_test

deployment:
    production:
        branch: master
        commands:
            - run upload_package